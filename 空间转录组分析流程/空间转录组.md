完整的空间转录组（Spatial Transcriptomics, ST）分析流程，
涵盖了从数据准备、质控、标准化、聚类分析、空间可视化、差异表达分析到功能注释的详细步骤和
可直接使用的代码（基于10X Genomics Visium平台，使用Seurat、SpatialExperiment和ggplot2等R包）。

作者：染山    更新日期：20250803

### ✅ 空间转录组分析具体步骤（基于10X Visium + Seurat）

一、环境准备

    安装并加载 Seurat、ggplot2、patchwork、dplyr 等R包。

二、读取空间转录组数据

    使用 Load10X_Spatial() 函数读取 Visium 数据文件夹（包含表达矩阵和组织图像）。

三、质控（QC）

    计算每个spot的线粒体比例（PercentageFeatureSet）。

    过滤低质量spot（如基因数过少或过多、线粒体比例高）。

    可视化 QC 指标（如nFeature_RNA, percent.mt）。

四、标准化与高变基因选择

    使用 SCTransform 进行归一化和高变基因识别。

五、降维与聚类分析

    运行 PCA 降维 (RunPCA)。

    构建邻接图并进行聚类 (FindNeighbors + FindClusters)。

    运行 UMAP 进行可视化 (RunUMAP)。

六、空间可视化

    使用 SpatialDimPlot 展示组织结构和聚类结果。

    使用 SpatialFeaturePlot 可视化基因在空间组织中的表达。

七、差异表达分析

    使用 FindAllMarkers 查找不同空间聚类的标志基因。

    输出每个聚类中上调的关键基因。

八、GO/KEGG 功能富集分析（可选）

    将差异基因转换为ENTREZ ID（使用 bitr）。

    使用 enrichGO() 进行功能注释分析。

    使用 barplot() 或 dotplot() 展示结果。

九、空间结构识别（可选高级）

    进一步使用 BayesSpace、SpatialDE 或 Giotto 等工具识别空间域。

十、保存分析结果

    使用 saveRDS() 保存 Seurat 对象。

    使用 write.csv() 导出差异表达基因表格。

---

## 🧬 0 环境准备

```r
# 安装必要R包（如未安装）
if (!require("Seurat")) install.packages("Seurat")
if (!require("SeuratData")) install.packages("SeuratData")
if (!require("patchwork")) install.packages("patchwork")
if (!require("ggplot2")) install.packages("ggplot2")
if (!require("dplyr")) install.packages("dplyr")

# 加载
library(Seurat)
library(SeuratData)
library(patchwork)
library(ggplot2)
library(dplyr)
```

## 📂 1 读取空间转录组数据

数据目录包含：

    filtered_feature_bc_matrix/

    spatial/ 文件夹（含图像和定位信息）

```r
# 替换为你的数据目录
data_dir <- "/path/to/your/spatial/data"

# 创建Seurat对象
st_data <- Load10X_Spatial(data.dir = data_dir)

# 查看对象基本信息
st_data
```

## 🔍 2 质控（QC）

```r
# 计算线粒体比例
st_data[["percent.mt"]] <- PercentageFeatureSet(st_data, pattern = "^MT-")

# 可视化QC指标
VlnPlot(st_data, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), pt.size = 0.1)

# 筛选低质量点
st_data <- subset(st_data, subset = nFeature_RNA > 200 & nFeature_RNA < 7500 & percent.mt < 5)
```

## 🧪 3 标准化 & 高变基因筛选

```r
st_data <- SCTransform(st_data, assay = "Spatial", verbose = FALSE)
```

## 🧬 4 降维、聚类、UMAP

```r
st_data <- RunPCA(st_data, assay = "SCT", verbose = FALSE)
st_data <- FindNeighbors(st_data, reduction = "pca", dims = 1:30)
st_data <- FindClusters(st_data, resolution = 0.5)
st_data <- RunUMAP(st_data, reduction = "pca", dims = 1:30)
```

## 🗺️5 空间可视化

```r
# 空间点图
SpatialDimPlot(st_data, label = TRUE, label.size = 3)

# 某基因在组织中的表达分布
SpatialFeaturePlot(st_data, features = c("Snap25", "Mbp", "Gad1"))
```

### 🧬 6 差异表达分析

```r
# 获取所有cluster间差异表达基因
cluster_markers <- FindAllMarkers(st_data, only.pos = TRUE, min.pct = 0.25, logfc.threshold = 0.25)

# 查看top marker
cluster_markers %>% group_by(cluster) %>% top_n(n = 5, wt = avg_log2FC)
```

## 🧠 7 GO/KEGG 富集分析（可选）

```r
# 使用clusterProfiler包进行富集分析：

if (!require("clusterProfiler")) install.packages("clusterProfiler")
library(clusterProfiler)
library(org.Hs.eg.db)

# 假设我们分析第一个cluster
genes <- cluster_markers %>% filter(cluster == 0) %>% pull(gene)

# 转换为ENTREZID
entrez_genes <- bitr(genes, fromType="SYMBOL", toType="ENTREZID", OrgDb=org.Hs.eg.db)

# GO分析
go_result <- enrichGO(gene = entrez_genes$ENTREZID, OrgDb = org.Hs.eg.db, ont = "BP", readable = TRUE)

# 可视化
barplot(go_result, showCategory = 10)
```

## 🌐 8 空间域识别（Space Ranger 或 SpatialDE）

若有物理组织位置信息和spot坐标，可使用BayesSpace、Giotto等工具进行空间域建模。
若需，我可继续给出这些高级方法。

## 📌 9 保存结果

```r
# 保存Seurat对象
saveRDS(st_data, file = "your_sample_spatial_seurat.rds")

# 导出差异表达基因
write.csv(cluster_markers, "cluster_markers.csv", row.names = FALSE)
```

## 🗃️ 附录：常见数据资源

    10x Genomics 示例数据

    Human Protein Atlas

    SpatialDE
