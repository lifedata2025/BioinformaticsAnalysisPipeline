作者：染山    更新日期：20250803

### 完整的孟德尔随机化（Mendelian Randomization, MR）分析流程，包括：

    分析概述

    分析流程图

    每一步的详细步骤与代码

    常用R包与可视化方法

---

## 🧬 一、分析概述

**孟德尔随机化（MR）**是一种利用遗传变异（SNPs）作为工具变量（Instrumental Variables, IVs）评估暴露（exposure）与结局（outcome）之间因果关系的方法，基于遗传变异在出生时被随机分配的原理。

## 🔁 二、分析流程图

graph TD
  A[选择Exposure] --> B[获取Exposure GWAS summary data]
  B --> C[筛选显著SNPs (P<5e-8)]
  C --> D[LD剪枝 (R2<0.01, 10,000kb)]
  D --> E[提取Outcome GWAS数据]
  E --> F[Harmonization (对齐效应等位基因)]
  F --> G[MR因果推断分析]
  G --> H[敏感性分析: 异质性/多效性检验]
  H --> I[结果可视化与解释]

## 🧪 三、分析步骤与代码（基于 R TwoSampleMR 包）

    所需 R 包：TwoSampleMR, MRPRESSO, data.table, dplyr, ggplot2

---

## ✅ Step 1. 安装并加载 R 包

```r
install.packages("remotes")
remotes::install_github("MRCIEU/TwoSampleMR")
remotes::install_github("rondolab/MR-PRESSO")

library(TwoSampleMR)
library(MRPRESSO)
library(data.table)
library(dplyr)
library(ggplot2)
```

## ✅ Step 2. 选择 Exposure 和 Outcome

例如：BMI（Exposure）与冠心病 CHD（Outcome）

```r
available_exposures <- available_exposures()
available_outcomes <- available_outcomes()
```

你也可以下载 GWAS summary 文件，自定义数据。

## ✅ Step 3. 获取 Exposure 的GWAS数据

```r
# 示例: 选择BMI作为exposure (ID: ukb-b-19953)
exposure_data <- extract_instruments(outcomes = "ukb-b-19953", clump = TRUE)
```

## ✅ Step 4. 提取 Outcome 数据

```r
# 选择冠心病 (ID: ebi-a-GCST003116)
outcome_data <- extract_outcome_data(
  snps = exposure_data$SNP,
  outcomes = "ebi-a-GCST003116"
)
```

## ✅ Step 5. Harmonize Exposure 与 Outcome 数据

```r
harmonized_data <- harmonise_data(exposure_data, outcome_data)
```

## ✅ Step 6. 进行 MR 分析

```r
mr_results <- mr(harmonized_data)
print(mr_results)
```

常见方法包括：

    IVW（Inverse Variance Weighted）

    MR-Egger

    Weighted median

## ✅ Step 7. 敏感性分析

```r
# 7.1 异质性检验

mr_heterogeneity(harmonized_data)

# 7.2 多效性检验

mr_pleiotropy_test(harmonized_data)

# 7.3 单SNP分析

mr_singlesnp(harmonized_data) %>%
  mr_forest_plot()

# 7.4 Leave-one-out分析

mr_leaveoneout(harmonized_data) %>%
  mr_leaveoneout_plot()

# 7.5 PRESSO分析（检测异常值）

MRPRESSO::mr_presso(BetaOutcome = "beta.outcome",
                    BetaExposure = "beta.exposure",
                    SdOutcome = "se.outcome",
                    SdExposure = "se.exposure",
                    OUTLIERtest = TRUE,
                    DISTORTIONtest = TRUE,
                    data = harmonized_data,
                    NbDistribution = 1000,
                    SignifThreshold = 0.05)
```

## ✅ Step 8. 可视化结果

```r
# 散点图

mr_scatter_plot(mr_results, harmonized_data)

# 火山图（Volcano plot）

library(ggplot2)

ggplot(mr_results, aes(x = method, y = b, color = method)) +
  geom_point(size = 4) +
  geom_errorbar(aes(ymin = b - se, ymax = b + se), width = 0.2) +
  theme_minimal() + labs(y = "Effect Estimate (Beta)", x = "")
```

## 📦 四、其他常用资源

    GWAS 数据库：

        IEU OpenGWAS

        GWAS Catalog

    自定义 GWAS 文件使用 read_exposure_data() 和 read_outcome_data()

## 📝 五、示例结论解读模板

使用 TwoSampleMR 包对 BMI 与冠心病（CHD）之间的关系进行了 MR 分析。IVW 方法结果显示 β = 0.11, p = 3e-5，提示 BMI 增加显著增加CHD风险。敏感性分析未发现显著异质性或多效性。结果具有稳健性。

## 📁 六、结果汇总表格建议
| Method	| Beta	| SE	| P-value	| OR	| 95%CI |
|----|----|----|----|----|----|
| IVW	| 0.11	| 0.02	| 3e-5	| 1.12	| 1.07–1.17 |
| MR-Egger	| 0.09	| 0.05	| 0.07	| -	| - |
| Weighted Med	| 0.10	| 0.03	| 0.001	| 1.11	| 1.04–1.18 |
