时空转录组（Spatiotemporal Transcriptomics）分析的完整流程，包括流程图解、具体步骤与代码模板，
适用于常见的公开数据集（如 Slide-seq、Stereo-seq、HDST、10x Visium 等）结合时间点设计的分析项目。

作者：染山   更新日期：20250803

🧬 时空转录组分析完整流程（Spatiotemporal Transcriptomics Workflow）

🔁 分析流程总览图（逻辑步骤）

数据准备 ➝ 预处理与质控 ➝ 空间定位 ➝ 时间点整合 ➝ 聚类与可视化 ➝ 时空差异表达 ➝ 时空轨迹推断 ➝ 功能富集分析 ➝ 可视化展示

---

### 🧪 具体步骤和代码（以 Python + R 为主）

## 🧾 1. 数据准备

准备空间转录组原始数据（如 .h5, .mtx, .tsv, .png 等）+ 时间点元信息。

# 示例文件结构
data/
 ├── timepoint1/
 │    ├── spatial/        # 包含空间图像和定位信息
 │    └── count_matrix/
 └── timepoint2/

## 🧼 2. 数据预处理与质控（R/Seurat）


```r
library(Seurat)
library(SeuratData)

# 读取每个时间点的空间数据
tp1 <- Load10X_Spatial(data.dir = "data/timepoint1")
tp2 <- Load10X_Spatial(data.dir = "data/timepoint2")

# 添加时间点标签
tp1$time <- "day0"
tp2$time <- "day3"

# 合并对象
combined <- merge(tp1, tp2)

# 标准预处理
combined <- SCTransform(combined, assay = "Spatial", verbose = FALSE)
combined <- RunPCA(combined)
combined <- RunUMAP(combined, dims = 1:30)
```

## 🗺️ 3. 空间定位与可视化

```r
SpatialFeaturePlot(combined, features = c("GeneA", "GeneB"), pt.size.factor = 1.6)
```

## ⌛ 4. 时间点整合与批次校正

```r
combined <- RunHarmony(combined, group.by.vars = "time")
combined <- RunUMAP(combined, reduction = "harmony", dims = 1:30)
DimPlot(combined, group.by = "time")
```

## 📦 5. 聚类分析与细胞类型注释

```r
combined <- FindNeighbors(combined, reduction = "harmony", dims = 1:30)
combined <- FindClusters(combined, resolution = 0.5)

# 细胞类型注释（根据marker基因）
FeaturePlot(combined, features = c("Snap25", "Mbp", "Gfap"))  # 神经、胶质等
```

## 🧬 6. 时空差异表达分析

```r
# 选取特定时间点差异
Idents(combined) <- "time"
de_genes <- FindMarkers(combined, ident.1 = "day3", ident.2 = "day0", group.by = "time")

# 空间差异表达基因可视化
SpatialFeaturePlot(combined, features = head(rownames(de_genes), 4))
```

## ⏳ 7. 时空轨迹推断（ST + pseudotime）

使用 Monocle3, scVelo 或 stLearn 实现时空轨迹分析：
示例：Monocle3 轨迹分析

```r
library(monocle3)
cds <- as.cell_data_set(combined)
cds <- cluster_cells(cds)
cds <- learn_graph(cds)
cds <- order_cells(cds)
plot_cells(cds, color_cells_by = "pseudotime")
```

## 📊 8. GO/KEGG 富集分析（clusterProfiler）

```
library(clusterProfiler)
library(org.Mm.eg.db)

ego <- enrichGO(gene = rownames(de_genes)[1:100],
                OrgDb = org.Mm.eg.db, 
                keyType = "SYMBOL", 
                ont = "BP", 
                pAdjustMethod = "BH")
barplot(ego)
```

## 📌 9. 可视化展示（空间时间联合）

```r
# UMAP+时间分组
DimPlot(combined, group.by = "time", split.by = "time")

# 空间点动态热图
SpatialFeaturePlot(combined, features = "GeneX") + ggtitle("GeneX expression over time")
```

## 🧰 可选工具推荐
| 工具名 |	用途 | 语言 |
|---|---|---|
|Seurat + Harmony	| 数据整合与空间分析	| R |
|stLearn | ST轨迹分析	Python |
|Monocle3	| 伪时间推断	R |
|Giotto | 空间表达高级可视化	R |
|Scanpy + scVelo	| 动态轨迹分析	Python |
